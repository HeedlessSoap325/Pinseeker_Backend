# API Documentation

This document describes the available API routes, their methods, required parameters, and functionality.

---

## Authentication

### `PUT /auth/register`

**Description:** Registers a new user.

**Request Body:**
```json
{
    "username": "string",
    "password" : "string"
}
```

**Response:**
```json
{
    "username" : "string"
}
```

---

### `POST /user/create`

**Description:** Creates the user that was registered before and enables it.

**Request Body:**
```json
{
  "user_id" : int,
  "username" : "string",
  "password" : "string",
  "profile_location" : "string",
  "email" : "string",
  "about" : "string",
  "is_profile_private" : boolean,
  "public_rsa_key" : "string"
}
```
The ```username``` and ```password``` properties must contain the same credentials as the beforehand registered user.
The other properties can be left empty (```""```), except the ```public_rsa_key``` witch must contain a rsa key,
generated by the client and linked to a **private key** stored on the client's device.

**Note:** The **client must handle all encryption and decryption**. If a private key is lost, it **cannot be recovered**.
The client must then generate a new keypair and update its ```public_rsa_key``` using the `PUT /user/` route.
All sent and received messages can no longer be decrypted, but clients will use the updated ```public_rsa_key```
to encrypt and send new messages, which can then be decrypted.

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `POST /api/auth/login`

**Description:** Logs in a user and returns a JWT token.

**Request Body:**
```json
{
  "username": "string",
  "password": "string"
}
```

**Response:**
```json
{
  "user": {
      "username": "string",
    "is_premium": boolean,
    "user_id": int,
    "profile_picture": "string",
    "number_of_finds": int
  },
  "jwt": "string"
}
```

---

## User

### `GET /user/{user_id}`

**Description:** Gets all information about a given user.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
user_id: The requested users id
```

**Response:**
```json
{
    "username": "string",
    "email": "string" || null,
    "about": "string" || null,
    "is_premium": boolean,
    "found_pins": null || {
        "TRADITIONAL": "int",
        "MULTI": "int",
        "MYSTERY": "int"
    },
    "user_id": int,
    "joined_at": Date,
    "is_profile_private": boolean,
    "profile_picture": "string" || null,
    "profile_location": "string" || null,
    "number_of_finds": "int" || null,
    "hidden_pins": null || {
        "TRADITIONAL": int,
        "MULTI": int,
        "MYSTERY": int
    },
    "number_of_hides": "int" || null
}
```
All properties denoted with ```|| null``` might contain null-values, because ```is_profile_private``` is set to ```true```
or the property has not been set in the first place.

---

### `PUT /user/`

**Description:** Update the users personal information.

**Headers:**
```
Authorization: Bearer token

password: The users (old) password
```

**Request Body:**
```json
{
    "user_id" : int,
    "username" : "string",
    "password" : "string",
    "profile_location" : "string",
    "email" : "string",
    "about" : "string",
    "is_profile_private" : boolean,
    "public_rsa_key" : "string"
}
```
The properties ```username```, ```password``` and ```public_rsa_key``` may be left empty (```""```) if the given property should not be updated.
Otherwise, the provided value will **override** the existing value, if possible.

All other properties must either contain their **original contents** to remain unchanged, contain **new content** to be changed, 
or be **left empty** (```""```) to make the field private.

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `DELETE /user/`

**Description:** Delete / Anonymize the user.

**Headers:**
```
Authorization: Bearer token
```

**Request Body:**
```text
"current user password"
```

**Response:**

No custom response data, just ```message``` or ```error```.

**Note:** The user is not deleted, but rather anonymized. This serves the Purpose of preserving Logs, Pins and Chats with other users.
The username is changed to **DeletedUser@UUID** and all personal information is removed.

The profile picture will be set to ``` DELETED_PROFILE_PICTURE```, witch by default is ```deleted.jpg```.

---

### `PUT /user/picture`

**Description:** Add / Update a users profile picture.

**Headers:**
```
Authorization: Bearer token
```

**Request Body:**

form-data with ```image``` as the key and the picture as a File.

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `DELETE /user/picture`

**Description:** Delete a users profile picture.

**Headers:**
```
Authorization: Bearer token
```

**Response:**

No custom response data, just ```message``` or ```error```.

The profile picture will be set to ``` DEFAULT_PROFILE_PICTURE```, witch by default is ```default.jpg```.

---

### `GET /user/{user_id}/found_pins`

**Description:** Get a List of all pins found by a user.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
user_id: The requested users id
```

**Response:**
```json
[
    {
        "pin_id": int,
        "latitude": double
        "longitude": double,
        "name": "string",
        "type": "TRADITIONAL" || "MYSTERY" || "MULTI",
        "premium": boolean,
        "difficulty": float,
        "terrain": float,
        "size": "MICRO" || "SMALL" || "REGULAR" || "LARGE" || "OTHER",
        "hider": {
            "username": "string",
            "is_premium": boolean,
            "user_id": int,
            "profile_picture": "string",
            "number_of_finds": null
        },
        "created_at": "string",
        "hint": "string",
        "description": "string",
        "status": "ACTIVE" || "DEACTIVATED" || "IN_MAINTENANCE" || "ARCHIVED"
    },
    {
        ...
    }
]
```

---

### `GET /user/{user_id}/hidden_pins`

**Description:** Get a List of all pins hidden by a user.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
user_id: The requested users id
```

**Response:**
```json
[
    {
        "pin_id": int,
        "latitude": double
        "longitude": double,
        "name": "string",
        "type": "TRADITIONAL" || "MYSTERY" || "MULTI",
        "premium": boolean,
        "difficulty": float,
        "terrain": float,
        "size": "MICRO" || "SMALL" || "REGULAR" || "LARGE" || "OTHER",
        "hider": {
            "username": "string",
            "is_premium": boolean,
            "user_id": int,
            "profile_picture": "string",
            "number_of_finds": null
        },
        "created_at": "string",
        "hint": "string",
        "description": "string",
        "status": "ACTIVE" || "DEACTIVATED" || "IN_MAINTENANCE" || "ARCHIVED"
    },
    {
        ...
    }
]
```

---

### `POST /user/upgrade`

**Description:** Upgrade to premium.

**Headers:**
```
Authorization: Bearer token
```

**Response:**

No custom response data, just ```message``` or ```error```.

**Note:** There is no actual payment logic implemented, the user will just get premium.

---

### `GET /user/search`

**Description:** Search users by username.

**Headers:**
```
Authorization: Bearer token
```

**Request Body:**
```text
"username or part of username"
```

**Response:**
```json
[
    {
        "username": "string",
        "is_premium": boolean,
        "user_id": int,
        "profile_picture": "string",
        "number_of_finds": null
    },
    {
        ...
    }
]
```

---

## Chat

### `POST /chats/`

**Description:** Create a new chat with another user.

**Headers:**
```
Authorization: Bearer token

target_user_id: id of the other user
```

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `GET /chats/`

**Description:** Get all chats for user.

**Headers:**
```
Authorization: Bearer token
```

**Response:**
```json
[
    {
        "last_message_encrypted": "string",
        "created_at": "string",
        "last_message_encrypted_aes_key": "string",
        "username": "string",
        "state": "active" || "inactive" || "read-only",
        "chat_id" : "string"
    },
    {
        ...
    }
]
```

---

### `PUT /chats/`

**Description:** Change the Status of a Chat.

**Headers:**
```
Authorization: Bearer token

chat_id: id of the chat whose status should be changed
```

**Response:**

No custom response data, just ```message``` or ```error```.

**Note:** Sending a request to this Route will toggle the chat state from ```inactive -> active``` or ```active -> inactive```.
It is intended to serve as a sort of **sorting system**, to display older chats at the bottom and newer chats at the top.

---

### `GET /chats/{chat_id}`

**Description:** Get information and messages for a chat.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
chat_id: id of the requested chat
```

**Response:**
```json
{
    "participant": {
        "username": "string",
        "profile_picture": "string",
        "user_id": int,
        "public_rsa_key": "string"
    },
    "messages": [
        {
            "was_sender_other_user": true,
            "encrypted_message": "string",
            "direct_message_id": int,
            "created_at": Date,
            "encrypted_aes_key": "string"
        },
        {
            ...
        }
    ],
    "chat_id": int,
    "chat_state": "ACTIVE" || "INACTIVE" || "READ_ONLY"
}
```

---

### `POST /chats/{chat_id}`

**Description:** Send a message in a chat

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
chat_id: id of the intended chat
```

**Request Body:**
```json
{
    "receiver_encrypted_message" : "string",
    "receiver_encrypted_aes_key" : "string",
    "sender_encrypted_message" : "string",
    "sender_encrypted_aes_key" : "string"
}
```

**Response:**

No custom response data, just ```message``` or ```error```.

**Note:** The **client must handle all encryption and decryption**. To encrypt a message, the client shall:

**1.** generate a random aes key for itself as well as the receiver.

**2.** encrypt the message using the respective generated aes key.

**3.** encrypt the aes key with the respective public key.

**Decryption** is handled the same way. The client must:

**1.** Decrypt the random aes key using its private key.

**2.** Decrypt the message using the decrypted aes key.

---

### `PUT /chats/{chat_id}`

**Description:** Edit a message in a chat

**Headers:**
```
Authorization: Bearer token

message_id: id of the message to be edited
```

**Path Variables:**
```
chat_id: id of the intended chat
```

**Request Body:**
```json
{
    "receiver_encrypted_message" : "string",
    "receiver_encrypted_aes_key" : "string",
    "sender_encrypted_message" : "string",
    "sender_encrypted_aes_key" : "string"
}
```

Note: see [POST /chats/{chat_id}](./api.md#post-chatschat_id) on how to encrypt and decrypt the message.

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `DELETE /chats/{chat_id}`

**Description:** Delete a message in a chat

**Headers:**
```
Authorization: Bearer token

message_id: id of the message to be deleted
```

**Path Variables:**
```
chat_id: id of the intended chat
```

**Response:**

No custom response data, just ```message``` or ```error```.

---

## Pin

### `POST /pins/`

**Description:** Create a new Pin.

**Headers:**
```
Authorization: Bearer token
```

**Request Body:**
```json
{
    "latitude" : double,
    "longitude" : double,
    "name" : "string",
    "type" : "TRADITIONAL" || "MYSTERY" || "MULTI",
    "premium" : boolean,
    "difficulty" : float,
    "terrain" : float,
    "size" : "MICRO" || "SMALL" || "REGULAR" || "LARGE" || "OTHER",
    "hint" : "string",
    "description" : "string"
}
```

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `GET /pins/{pin_id}`

**Description:** Get a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the requested pin
```

**Response:**
```json
{
    "pin_id": int,
    "latitude": double,
    "longitude": double,
    "name": "string",
    "type": "TRADITIONAL" || "MYSTERY" || "MULTI",
    "premium": boolean,
    "difficulty": float,
    "terrain": float,
    "size": "MICRO" || "SMALL" || "REGULAR" || "LARGE" || "OTHER",
    "hider": {
        "username": "string",
        "is_premium": boolean,
        "profile_picture": "string",
        "user_id": int,
        "number_of_finds": null
    },
    "created_at": "string",
    "hint": "string",
    "description": "string",
    "status": "ACTIVE" || "DEACTIVATED" || "IN_MAINTENANCE" || "ARCHIVED"
}
```

**Note:** The Pin must have the same or a lower ```premium-level``` than the user. Otherwise, there will be an error.

---

### `PUT /pins/{pin_id}`

**Description:** Update a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the intended pin
```

**Request Body:**
```json
{
    "pin_id" : int,
    "latitude" : double,
    "longitude" : double,
    "name" : "string",
    "type" : "TRADITIONAL" || "MYSTERY" || "MULTI",
    "premium" : boolean,
    "difficulty" : float,
    "terrain" : float,
    "size" : "MICRO" || "SMALL" || "REGULAR" || "LARGE" || "OTHER",
    "hint" : "string",
    "description" : "string"
}
```
The provided values will **override** the existing values, if possible. All empty (```""```) properties will be private, 
as long as the property can be empty.

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `DELETE /pins/{pin_id}`

**Description:** Delete / Deactivate a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the intended pin
```

**Response:**

No custom response data, just ```message``` or ```error```.

**Note:** The Pin does **not get deleted out of the Database**, but rather the status gets set to ```DEACTIVATED```.
The Pin can then not be logged anymore, except for the hider, who can re-activate the Pin if they wish to do so.
This serves the Purpose of preserving the ```number_of_found_pins``` for users and maintaining the option to reverse the 'deletion.'

---

### `POST /pins/{pin_id}/logs`

**Description:** Post a log to a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the intended pin
```

**Request Body:**
```json
{
  "type" : "FOUND" || "NOT_FOUND" || "NOTICE" || "MAINTENANCE_REQUIRED" || "MAINTENANCE_PERFORMED" || "DEACTIVATE" || "ACTIVATE" || "ARCHIVE",
  "message" : "string",
  "has_image" : boolean
}
```
The log message does not need to be encrypted, as it would be impossible and als unnecessary.

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `GET /pins/{pin_id}/logs`

**Description:** Get all logs for a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the intended pin
```

**Response:**
```json
[
    {
        "type": "FOUND" || "NOT_FOUND" || "NOTICE" || "MAINTENANCE_REQUIRED" || "MAINTENANCE_PERFORMED" || "DEACTIVATE" || "ACTIVATE" || "ARCHIVE",
        "logger": {
            "username": "string",
            "is_premium": boolean,
            "profile_picture": "string",
            "user_id": int
            "number_of_finds": int
        },
        "message": "string",
        "has_image": boolean,
        "image_url": "string" || null,
        "created_at": "string",
        "log_id": int
    },
    {
        ...
    }
]
```

**Note:** The Pin must have the same or a lower ```premium-level``` than the user. Otherwise, there will be an error.

---

### `PUT /pins/{pin_id}/logs/{log_id}`

**Description:** Edit a specific Log on a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the intended pin

log_id: id of the intended log
```

**Request Body:**
```json
{
    "type" : "FOUND" || "NOT_FOUND" || "NOTICE" || "MAINTENANCE_REQUIRED" || "MAINTENANCE_PERFORMED" || "DEACTIVATE" || "ACTIVATE" || "ARCHIVE",
    "message" : "string",
    "has_image" : boolean
}
```

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `DELETE /pins/{pin_id}/logs/{log_id}`

**Description:** Delete a specific Log on a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the intended pin

log_id: id of the intended log
```

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `PUT /pins/{pin_id}/logs/{log_id}/image`

**Description:** Add / Update an image of a specific Log on a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the intended pin

log_id: id of the intended log
```

**Request Body:**

```form-data``` with ```image``` as the key and the picture as a File.

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `DELETE /pins/{pin_id}/logs/{log_id}/image`

**Description:** Delete an image of a specific Log on a specific Pin.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
pin_id: id of the intended pin

log_id: id of the intended log
```

**Response:**

No custom response data, just ```message``` or ```error```.

---

### `GET /pins/find`

**Description:** Get a List of Pins near a given Location.

**Headers:**
```
Authorization: Bearer token
```

**Request Body:**
```json
{
    "latitude" : double,
    "longitude" : double,
    "radius" : int
}
```

**Response:**
```json
[
    {
        "latitude": double,
        "longitude": double,
        "pin_id": int
    },
    {
        ...
    }
]
```

---

## Images

### `GET /profile_pictures/{profile_picture}`

**Description:** Get the profile picture for a user.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
profile_picture: the value of the profile_picture property for any user
```

---

### `GET /log_images/{log_image}`

**Description:** Get the profile picture for a user.

**Headers:**
```
Authorization: Bearer token
```

**Path Variables:**
```
log_image: the value of the image_url property for any log
```